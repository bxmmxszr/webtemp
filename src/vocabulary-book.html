<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生词表 - 立信英语</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        /* 可以在这里添加一些自定义样式，如果需要的话 */
        .word-table-container {
            max-height: 600px; /* 设置表格容器最大高度 */
            overflow-y: auto;   /* 超出时显示垂直滚动条 */
        }
        .table th {
            position: sticky; /* 使表头在滚动时固定 */
            top: 0;
            background-color: #f8f9fa; /* Bootstrap card background color */
            z-index: 10; /* 确保表头在内容之上 */
        }
        /* 加载指示器样式 */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">立信英语</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#about">关于</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#services">服务</a></li>
                    <li class="nav-item"><a class="nav-link" href="si-nian-ji.html">文章</a></li>
                    <!-- 登录状态显示 - 添加的部分 -->
                    <li class="nav-item">
                        <span id="user-info" class="navbar-text me-2 d-none"></span>
                        <a href="profile.html" class="btn btn-outline-primary btn-sm me-1 d-none" id="profile-btn">个人中心</a>
                        <a href="learning-records.html" class="btn btn-outline-info btn-sm me-1 d-none" id="records-btn">学习记录</a>
                        <a href="admin-vocabulary.html" class="btn btn-outline-warning btn-sm me-1 d-none" id="admin-btn">管理员</a>
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-1">登录</button>
                        <button id="logout-btn" class="btn btn-outline-secondary btn-sm d-none">登出</button>
                    </li>
                    <!-- 登录状态显示结束 -->
                    <li class="nav-item"><a class="nav-link" href="index.html#contact">联系</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 生词表内容 -->
    <div class="container mt-5 pt-5">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>学习报告</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="learning-records.html" class="list-group-item list-group-item-action">词汇测试历史</a>
                        <a href="#" class="list-group-item list-group-item-action active">生词表</a>
						<a href="translation-history.html" class="list-group-item list-group-item-action">学习汇总</a>
                        <a href="data-export.html" class="list-group-item list-group-item-action">数据导出</a>
                        <!-- 可以在这里添加更多个人中心的链接 -->
                    </div>
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">我的生词表</h4>
                        <div>
                            <!-- 导出按钮 -->
                            <button id="export-btn" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="bi bi-download"></i> 导出 CSV
                            </button>
                            <!-- 刷新按钮 -->
                            <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="message" class="alert d-none" role="alert"></div>

                        <!-- 单词表格容器 -->
                        <div class="word-table-container">
                            <table class="table table-striped table-hover">
                                <!-- <thead class="table-light">									  -->
                                <!--     <tr>                                                         -->
                                <!--         <th scope="col">#</th>                                   -->
                                <!--         <th scope="col">单词</th>                                -->
                                <!--         <!-- <th scope="col">音标</th> --> <!-- 后端数据可能没有 phonetic 字段 -->
                                <!--         <th scope="col">释义</th>                                -->
                                <!--         <th scope="col">来源</th> <!-- 添加来源列                -->
                                <!--         <th scope="col">添加时间</th>                            -->
                                <!--         <th scope="col">操作</th>                                -->
                                <!--     </tr>                                                        -->
                                <!-- </thead>                                                         -->
								<thead class="table-light">
									<tr>
										<th scope="col">#</th>
										<th scope="col">单词</th>
										<th scope="col">音标</th>
										<th scope="col">释义</th>
										<th scope="col">词性</th>
										<th scope="col">难度</th>
										<th scope="col">分类</th>
										<th scope="col">来源</th>
										<th scope="col">添加时间</th>
										<th scope="col">操作</th>
									</tr>
								</thead>
                                <tbody id="vocabulary-table-body">
                                    <!-- 表格内容将通过 JavaScript 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2024 立信英语. 保留所有权利.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">用心打造高效英语学习平台</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 修改后的 apiService 对象，包含真实的 API 调用 ---
        const apiService = (function () {
            // 从 api.js 或直接定义 API 基础 URL
            const API_BASE_URL = window.ApiBaseUrl || 'http://localhost:3000/api';

            // 模拟从 localStorage 获取 token
            const TOKEN_KEY = 'token';
            function getAuthToken() {
                return localStorage.getItem(TOKEN_KEY);
            }

            return {
                // 真实的获取生词表数据的方法
                getVocabularyList: async function () {
                    const token = getAuthToken();
                    if (!token) {
                       return { success: false, error: '未登录' };
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/vocabulary`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                             const errorData = await response.json().catch(() => ({}));
                             throw new Error(errorData.error || `请求失败: ${response.status}`);
                        }

                        const result = await response.json();
                        return result; // 后端直接返回 { success: true, vocabulary: [...] }
                    } catch (error) {
                        console.error('获取生词表失败:', error);
                        return { success: false, error: error.message };
                    }
                },
                // 真实的获取错误单词数据的方法 (新增)
                getIncorrectWords: async function () {
                    const token = getAuthToken();
                    if (!token) {
                       return { success: false, error: '未登录' };
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/incorrect-words`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                             const errorData = await response.json().catch(() => ({}));
                             throw new Error(errorData.error || `请求失败: ${response.status}`);
                        }

                        const result = await response.json();
                        return result; // 后端返回 { success: true, records: [...] }
                    } catch (error) {
                        console.error('获取错误单词失败:', error);
                        return { success: false, error: error.message };
                    }
                },
                // 真实的删除生词方法
                deleteVocabularyItem: async function (wordId) {
                    const token = getAuthToken();
                    if (!token) {
                        return { success: false, error: '未登录' };
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/vocabulary/${wordId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                             const errorData = await response.json().catch(() => ({}));
                             throw new Error(errorData.error || `删除失败: ${response.status}`);
                        }

                        const result = await response.json();
                        return result; // 后端返回 { success: true, message: '...' }
                    } catch (error) {
                        console.error('删除生词失败:', error);
                        return { success: false, error: error.message };
                    }
                },
                logout: function () {
                    localStorage.removeItem(TOKEN_KEY);
                }
            };
        })();

        // --- 前端逻辑 ---
        // 检查登录状态 (与 data-export.html 相同)
        async function checkLogin() {
            const token = localStorage.getItem('token');
            const userInfo = document.getElementById('user-info');
            const profileBtn = document.getElementById('profile-btn');
            const recordsBtn = document.getElementById('records-btn');
            const adminBtn = document.getElementById('admin-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            if (!token) {
                loginBtn.classList.remove('d-none');
                document.getElementById('vocabulary-table-body').innerHTML = '<tr><td colspan="6" class="text-center">请先 <a href="login.html">登录</a> 查看您的生词表。</td></tr>';
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/api/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (result.success) {
                    const user = result.user;
                    userInfo.textContent = `欢迎, ${user.name || user.email}`;
                    userInfo.classList.remove('d-none');
                    profileBtn.classList.remove('d-none');
                    recordsBtn.classList.remove('d-none');
                    // 检查是否为管理员
                    const adminEmails = ['admin@example.com', 'admin@liuxinenglish.com']; // 应从后端获取
                    if (adminEmails.includes(user.email)) {
                        adminBtn.classList.remove('d-none');
                    }
                    loginBtn.classList.add('d-none');
                    logoutBtn.classList.remove('d-none');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                localStorage.removeItem('token');
                document.getElementById('vocabulary-table-body').innerHTML = '<tr><td colspan="6" class="text-center">登录状态检查失败，请 <a href="login.html">重新登录</a>。</td></tr>';
            }
        }

        // 显示消息
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `alert alert-${type} d-block`;
            // 5秒后自动隐藏
            setTimeout(() => {
                messageDiv.classList.add('d-none');
            }, 5000);
        }

        // 加载生词表数据到表格 (修改后)
        //async function loadVocabularyList() {
        //    try {
        //        showMessage('正在加载生词表...', 'info');
        //        const result = await apiService.getVocabularyList();
        //        console.log("从后端获取的生词表数据:", result);
		//
        //        const tableBody = document.getElementById('vocabulary-table-body');
        //        tableBody.innerHTML = ''; // 清空现有内容
		//
        //        if (result.success) {
        //            const vocabList = result.vocabulary || [];
        //            if (vocabList.length === 0) {
        //                 tableBody.innerHTML = '<tr><td colspan="6" class="text-center">您的生词表是空的。</td></tr>';
        //                 showMessage('生词表加载完成，但列表为空。', 'warning');
        //                 return;
        //            }
		//
        //            //vocabList.forEach((item, index) => {
        //            //    const addedDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A';
        //            //    const row = document.createElement('tr');
        //            //    row.innerHTML = `
        //            //        <th scope="row">${index + 1}</th>
        //            //        <td>${item.word || 'N/A'}</td>
        //            //        <td>${item.translation || 'N/A'}</td>
        //            //        <td>${item.source || 'N/A'}</td>
        //            //        <td>${addedDate}</td>
        //            //        <td>
        //            //            <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${item._id}">
        //            //                <i class="bi bi-trash"></i>
        //            //            </button>
        //            //        </td>
        //            //    `;
        //            //    tableBody.appendChild(row);
        //            //});
		//			vocabList.forEach((item, index) => {
		//				// 根据后端返回的合并后数据结构调整字段
		//				const addedDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A';
		//				// --- 关键修改：使用新的字段名 ---
		//				const row = document.createElement('tr');
		//				row.innerHTML = `
		//					<th scope="row">${index + 1}</th>
		//					<td><strong>${item.word || 'N/A'}</strong></td>
		//					<!-- <td>${item.pronunciation || item.phonetic || ''}</td> --> <!-- 如果 CSV 数据中有音标字段 -->
		//					<td>${item.translation || 'N/A'}</td>
		//					<td>${item.partOfSpeech || ''}</td> <!-- 显示词性 -->
		//					<td>${item.difficulty || 'N/A'}</td> <!-- 显示难度 -->
		//					<td>${item.category || 'N/A'}</td> <!-- 显示分类 -->
		//					<td>${item.source || 'N/A'}</td> <!-- 显示来源 -->
		//					<td>${addedDate}</td>
		//					<td>
		//						<button class="btn btn-sm btn-outline-danger delete-btn ms-1" data-id="${item._id}">
		//							<i class="bi bi-trash"></i>
		//						</button>
		//					</td>
		//				`;
		//				tableBody.appendChild(row);
		//			});
        //            // 为新添加的删除按钮绑定事件
        //            document.querySelectorAll('.delete-btn').forEach(button => {
        //                button.addEventListener('click', async (e) => {
        //                    e.stopPropagation();
        //                    const wordId = e.currentTarget.getAttribute('data-id');
        //                    if (wordId && confirm('确定要删除这个单词吗？')) {
        //                        try {
        //                            showMessage('正在删除...', 'info');
        //                            const deleteResult = await apiService.deleteVocabularyItem(wordId);
        //                            if (deleteResult.success) {
        //                                showMessage('单词删除成功！', 'success');
        //                                // 重新加载列表以反映更改
        //                                loadVocabularyList();
        //                            } else {
        //                                throw new Error(deleteResult.error);
        //                            }
        //                        } catch (error) {
        //                            console.error('删除失败:', error);
        //                            showMessage('删除失败：' + error.message, 'danger');
        //                        }
        //                    }
        //                });
        //            });
		//
        //            showMessage('生词表加载成功！', 'success');
        //        } else {
        //            throw new Error(result.error || '加载失败');
        //        }
        //    } catch (error) {
        //        console.error('加载生词表失败:', error);
        //        showMessage('加载生词表失败：' + error.message, 'danger');
        //        document.getElementById('vocabulary-table-body').innerHTML = `<tr><td colspan="6" class="text-center">加载失败: ${error.message}</td></tr>`;
        //    }
        //}

            // 加载生词表数据到表格 (修改后 - 显示来自 CSV 的详细信息)
            async function loadVocabularyList() {
                try {
                    showMessage('正在加载生词表...', 'info');
                    const result = await apiService.getVocabularyList(); // 调用真实的后端 API
                    console.log("从后端获取的 enriched 生词表数据:", result); // 调试信息

                    const tableBody = document.getElementById('vocabulary-table-body');
                    tableBody.innerHTML = ''; // 清空现有内容

                    if (result.success) {
                        // --- 关键修改：使用 result.vocabulary (这是合并后的数据) ---
                        const vocabList = result.vocabulary || [];
                        // --- 关键修改结束 ---
                        if (vocabList.length === 0) {
                             tableBody.innerHTML = '<tr><td colspan="10" class="text-center">您的生词表是空的。</td></tr>'; // 更新 colspan
                             showMessage('生词表加载完成，但列表为空。', 'warning');
                             return;
                        }

                        vocabList.forEach((item, index) => {
                            // 根据后端返回的合并后数据结构调整字段
                            const addedDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A';
                            // --- 关键修改：使用合并后的字段 ---
                            const row = document.createElement('tr');
							let displayedSource = item.source || 'N/A';
							
							// --- 新增：尝试从 source 字符串中提取句子 ---
							try {
								// 假设 source 格式是 "前缀 - 句子:"句子内容""
								// 使用正则表达式匹配最后一个 " - 句子:" 后面的内容，并去除首尾引号
								const match = item.source?.match(/ - 句子:"(.*)"$/);
								if (match && match[1]) {
									displayedSource = match[1]; // 只显示匹配到的句子部分
								}
							} catch (e) {
								console.warn("解析 source 字段提取句子时出错:", e);
								// 如果解析失败，保留原始 source 或 'N/A'
							}
							// --- 新增结束 ---

                            row.innerHTML = `
                                <th scope="row">${index + 1}</th>
                                <td><strong>${item.word || 'N/A'}</strong></td>
                                <td>${item.pronunciation || ''}</td> <!-- 显示音标 -->
                                <td>${item.translation || 'N/A'}</td> <!-- 显示释义 -->
                                <td>${item.partOfSpeech || ''}</td> <!-- 显示词性 -->
                                <!-- <td>${item.example || ''}</td> --> <!-- 可选：显示例句 -->
                                <!-- <td>${item.exampleTranslation || ''}</td> --> <!-- 可选：显示例句翻译 -->
                                <td>${item.difficulty || 'N/A'}</td> <!-- 显示难度 -->
                                <td>${item.category || 'N/A'}</td> <!-- 显示分类 -->
                                <!-- <td>${item.source || 'N/A'}</td> --> <!-- 显示来源 -->
								<td>${displayedSource}</td>
                                <td>${addedDate}</td>
                                <td>
                                    <button class="btn btn-sm btn-outline-danger delete-btn ms-1" data-id="${item._id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });

                        // 为新添加的删除按钮绑定事件 (这部分通常不需要修改)
                        document.querySelectorAll('.delete-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                e.stopPropagation(); // 阻止事件冒泡
                                const wordId = e.currentTarget.getAttribute('data-id');
                                if (wordId && confirm('确定要删除这个单词吗？')) {
                                    try {
                                        showMessage('正在删除...', 'info');
                                        const deleteResult = await apiService.deleteVocabularyItem(wordId);
                                        if (deleteResult.success) {
                                            showMessage('单词删除成功！', 'success');
                                            // 重新加载列表以反映更改
                                            loadVocabularyList();
                                        } else {
                                            throw new Error(deleteResult.error);
                                        }
                                    } catch (error) {
                                        console.error('删除失败:', error);
                                        showMessage('删除失败：' + error.message, 'danger');
                                    }
                                }
                            });
                        });


                        showMessage('生词表加载成功！', 'success');
                    } else {
                        throw new Error(result.error || '加载失败');
                    }
                } catch (error) {
                    console.error('加载生词表失败:', error);
                    showMessage('加载生词表失败：' + error.message, 'danger');
                    // 确保表格显示错误信息
                    document.getElementById('vocabulary-table-body').innerHTML = `<tr><td colspan="10" class="text-center">加载失败: ${error.message}</td></tr>`; // 更新 colspan
                }
            }

        // --- 新增：在前端生成并下载 CSV ---
        // 生成 CSV 内容并触发下载
        function generateAndDownloadCSV(vocabularyData, incorrectWordsData) {
            try {
                // 定义 CSV 内容
                //let csvContent = "Data Type,Word,Translation,Part of Speech,Source/Context,Date Added/Recorded\n"; // Header
				let csvContent = "单词,音标,释义,词性,难度,分类,来源,添加时间"; // 与表格列一致的 Header
                csvContent += "\n"; // 添加换行符开始新的一行

                // 添加生词表数据
                //vocabularyData.forEach(item => {
                //    const word = item.word || '';
                //    const translation = item.translation || '';
                //    const partOfSpeech = item.partOfSpeech || '';
                //    const source = item.source || '';
                //    const dateAdded = item.createdAt ? new Date(item.createdAt).toISOString().split('T')[0] : '';
                //    // 简单的 CSV 转义：用双引号包围字段，如果字段内有双引号则将其替换为两个双引号
                //    const escape = (str) => `"${String(str).replace(/"/g, '""')}"`;
                //    csvContent += `Vocabulary,${escape(word)},${escape(translation)},${escape(partOfSpeech)},${escape(source)},${escape(dateAdded)}\n`;
                //});
				
				vocabularyData.forEach(item => {
                        // 提取与表格显示一致的数据
                        const word = item.word || '';
                        const pronunciation = item.pronunciation || '';
                        const translation = item.translation || '';
                        const partOfSpeech = item.partOfSpeech || '';
                        // const example = item.example || ''; // 如果需要例句列
                        // const exampleTranslation = item.exampleTranslation || ''; // 如果需要例句翻译列
                        const difficulty = item.difficulty || 'N/A';
                        const category = item.category || 'N/A';

                        // 处理 Source 字段以仅显示句子 (与前端显示逻辑一致) ---
                        let displayedSource = item.source || 'N/A';
                        try {
                            const match = item.source?.match(/ - 句子:"(.*)"$/);
                            if (match && match[1]) {
                                displayedSource = match[1];
                            }
                        } catch (e) {
                            console.warn(`解析单词 "${item.word}" 的 source 字段时出错:`, e);
                        }
						 const dateAdded = item.createdAt ? new Date(item.createdAt).toISOString().split('T')[0] : '';

						// --- CSV 转义 (仅处理双引号，不再处理非ASCII字符) ---
						const escapeAndQuote = (str) => {
							// 1. 转换为字符串
							let escapedStr = String(str);
							// 2. 将字段内的双引号(")替换为两个双引号("")
							escapedStr = escapedStr.replace(/"/g, '""');
							// 3. 用双引号包围整个字段
							return `"${escapedStr}"`;
						};

                        //// --- 修改点6：按照表格列顺序拼接 CSV 行 ---
                        //// csvContent += `"${word}","${translation}","${partOfSpeech}","${source}","${dateAdded}"\n`; // 旧格式
                        //csvContent += `${escapeAndQuote(word)},${escapeAndQuote(pronunciation)},${escapeAndQuote(translation)},${escapeAndQuote(partOfSpeech)},${escapeAndQuote(difficulty)},${escapeAndQuote(category)},${escapeAndQuote(displayedSource)},${escapeAndQuote(dateAdded)}\n`;
                        //// --- 修改点6结束 ---
						
						// --- 按照表格列顺序拼接 CSV 行 ---
						csvContent += `${escapeAndQuote(word)},${escapeAndQuote(pronunciation)},${escapeAndQuote(translation)},${escapeAndQuote(partOfSpeech)},${escapeAndQuote(difficulty)},${escapeAndQuote(category)},${escapeAndQuote(displayedSource)},${escapeAndQuote(dateAdded)}\n`;
						// --- 拼接结束 ---
						
                    });

                // --- 如果需要，也可以添加错误单词数据到同一个 CSV 文件 ---
                // 但根据你的要求“只导出词汇表和错误单词”，并且之前的实现是分开处理的，
                // 如果你只想要生词表，可以注释掉下面这部分。
                // 如果你想要在同一文件中也包含错误单词，可以取消注释并调整。
                /*
                if (incorrectWordsData && incorrectWordsData.length > 0) {
                    csvContent += "\n错误单词记录\n"; // 可以添加一个分隔标题
                    csvContent += "单词,关联生词ID,记录时间\n"; // 错误单词的表头
                    incorrectWordsData.forEach(item => {
                        const word = (item.vocabularyId && item.vocabularyId.word) || 'Unknown';
                        const vocabId = item.vocabularyId ? item.vocabularyId._id : item.vocabulary || 'N/A';
                        const recordTime = item.createdAt ? new Date(item.createdAt).toISOString().split('T')[0] : '';
                        
                        const escapeAndQuote = (str) => {
                            let escapedStr = String(str).replace(/"/g, '""');
                            escapedStr = escapedStr.replace(/[^\x00-\x7F]/g, '?');
                            return `"${escapedStr}"`;
                        };

                        csvContent += `${escapeAndQuote(word)},${escapeAndQuote(vocabId)},${escapeAndQuote(recordTime)}\n`;
                    });
                }
                */
                // --- 错误单词数据添加结束 ---
				
				// 添加错误单词数据
                incorrectWordsData.forEach(item => {
                    // 错误单词数据可能来自 populate 后的 vocabularyId 字段，或者自身字段
                    const word = (item.vocabularyId && item.vocabularyId.word) || item.word || 'Unknown';
                    const translation = (item.vocabularyId && item.vocabularyId.translation) || item.translation || 'N/A';
                    const partOfSpeech = (item.vocabularyId && item.vocabularyId.partOfSpeech) || item.partOfSpeech || '';
                    const context = 'Quiz/Test'; // 来源是测试
                    const dateRecorded = item.createdAt ? new Date(item.createdAt).toISOString().split('T')[0] : '';
                    const escape = (str) => `"${String(str).replace(/"/g, '""')}"`;
                    csvContent += `Incorrect Word,${escape(word)},${escape(translation)},${escape(partOfSpeech)},${escape(context)},${escape(dateRecorded)}\n`;
                });

                // 创建 Blob 对象
                //const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
				
				// --- 修改点7：创建 Blob 对象 (指定 ASCII 兼容的类型) ---
                // 注意：Blob 的 type 通常不影响内容编码，但 'text/csv' 是标准。
                // 真正的 ASCII 转换发生在上面字符串生成阶段。
                // const blob = new Blob([csvContent], { type: 'text/csv;charset=us-ascii;' }); // 尝试指定 ASCII
                // 实践中，很多程序（如 Excel）读取 UTF-8 BOM 的 CSV 更好
                // 但我们按要求生成尽可能接近 ASCII 的内容（非 ASCII 字符已替换）
                // 因此，使用默认 text/csv 通常是可以接受的，或者指定 utf-8 以避免歧义
                const blob = new Blob([`\uFEFF${csvContent}`], { type: 'text/csv;charset=utf-8;' }); // \uFEFF 是 UTF-8 BOM
					
				// 如果严格要求 ASCII 文件（不含 BOM），可以去掉 \uFEFF 并使用下面这行
                 // const blob = new Blob([csvContent], { type: 'text/csv;charset=us-ascii;' }); 
                // --- 修改点7结束 ---
					

                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                const now = new Date();
                const dateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                link.setAttribute('download', `vocabulary_and_errors_${dateString}.csv`);
				//link.setAttribute('download', `我的生词表_${dateString}.csv`); // 使用中文文件名
                link.style.visibility = 'hidden';

                // 触发下载
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // 清理 URL 对象
                URL.revokeObjectURL(url);

                showMessage('生词表和错误单词导出成功！文件将自动下载。', 'success');
            } catch (error) {
                console.error('生成 CSV 失败:', error);
                //showMessage('导出失败：' + error.message, 'danger');
				showMessage('导出失败：' + (error.message || '未知错误'), 'danger'); // 更健壮的错误处理
            }
        }

        // --- 修改：新的导出 CSV 功能 (只导出词汇表和错误单词) ---
        async function exportVocabularyAndErrorsCSV() {
            const exportBtn = document.getElementById('export-btn');
            const originalHtml = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span class="loading-spinner" role="status"></span> 导出中...';
            exportBtn.disabled = true;

            try {
                showMessage('正在准备导出文件...', 'info');

                // 1. 获取生词表数据
                const vocabResult = await apiService.getVocabularyList();
                if (!vocabResult.success) {
                    throw new Error('获取生词表失败: ' + vocabResult.error);
                }
                const vocabularyData = vocabResult.vocabulary || [];

                // 2. 获取错误单词数据
                const incorrectResult = await apiService.getIncorrectWords();
                if (!incorrectResult.success) {
                    throw new Error('获取错误单词失败: ' + incorrectResult.error);
                }
                const incorrectWordsData = incorrectResult.records || [];

                // 3. 生成并下载 CSV
                generateAndDownloadCSV(vocabularyData, incorrectWordsData);

            } catch (error) {
                console.error('导出失败:', error);
                showMessage('导出失败：' + error.message, 'danger');
            } finally {
                exportBtn.innerHTML = originalHtml;
                exportBtn.disabled = false;
            }
        }
        // --- 新增结束 ---

        // 登出功能
        document.getElementById('logout-btn').addEventListener('click', () => {
            apiService.logout();
            window.location.href = 'index.html';
        });

        // 登录按钮事件
        document.getElementById('login-btn').addEventListener('click', () => {
            window.location.href = 'login.html';
        });

        // 刷新按钮事件
        document.getElementById('refresh-btn').addEventListener('click', () => {
            loadVocabularyList();
        });

        // --- 修改：导出按钮事件 ---
        document.getElementById('export-btn').addEventListener('click', () => {
            exportVocabularyAndErrorsCSV(); // 调用新的导出函数
        });
        // --- 修改结束 ---

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            checkLogin().then(() => {
                 const token = localStorage.getItem('token');
                 if (token) {
                     loadVocabularyList();
                 }
            }).catch(err => {
                 console.log("初始化时遇到错误，可能已跳转或显示错误信息。", err);
            });
        });
    </script>
</body>
</html>