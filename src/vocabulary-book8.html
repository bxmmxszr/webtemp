<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>生词表 - 立信英语</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        /* 可以在这里添加一些自定义样式，如果需要的话 */
        .word-table-container {
            max-height: 600px; /* 设置表格容器最大高度 */
            overflow-y: auto;   /* 超出时显示垂直滚动条 */
        }
        .table th {
            position: sticky; /* 使表头在滚动时固定 */
            top: 0;
            background-color: #f8f9fa; /* Bootstrap card background color */
            z-index: 10; /* 确保表头在内容之上 */
        }
        /* 加载指示器样式 */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">立信英语</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#about">关于</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#services">服务</a></li>
                    <li class="nav-item"><a class="nav-link" href="si-nian-ji.html">文章</a></li>
                    <!-- 登录状态显示 - 添加的部分 -->
                    <li class="nav-item">
                        <span id="user-info" class="navbar-text me-2 d-none"></span>
                        <a href="profile.html" class="btn btn-outline-primary btn-sm me-1 d-none" id="profile-btn">个人中心</a>
                        <a href="learning-records.html" class="btn btn-outline-info btn-sm me-1 d-none" id="records-btn">学习记录</a>
                        <a href="admin-vocabulary.html" class="btn btn-outline-warning btn-sm me-1 d-none" id="admin-btn">管理员</a>
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-1">登录</button>
                        <button id="logout-btn" class="btn btn-outline-secondary btn-sm d-none">登出</button>
                    </li>
                    <!-- 登录状态显示结束 -->
                    <li class="nav-item"><a class="nav-link" href="index.html#contact">联系</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 生词表内容 -->
    <div class="container mt-5 pt-5">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>学习报告</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="learning-records.html" class="list-group-item list-group-item-action">测试历史</a>
                        <a href="#" class="list-group-item list-group-item-action active">生词表</a>
                        <a href="data-export.html" class="list-group-item list-group-item-action">数据导出</a>
                        <!-- 可以在这里添加更多个人中心的链接 -->
                    </div>
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">我的生词表</h4>
                        <div>
                            <!-- 导出按钮 -->
                            <button id="export-btn" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="bi bi-download"></i> 导出 CSV
                            </button>
                            <!-- 刷新按钮 -->
                            <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="message" class="alert d-none" role="alert"></div>

                        <!-- 单词表格容器 -->
                        <div class="word-table-container">
                            <table class="table table-striped table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th scope="col">#</th>
                                        <th scope="col">单词</th>
                                        <!-- <th scope="col">音标</th> --> <!-- 后端数据可能没有 phonetic 字段 -->
                                        <th scope="col">释义</th>
                                        <th scope="col">来源</th> <!-- 添加来源列 -->
                                        <th scope="col">添加时间</th>
                                        <th scope="col">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="vocabulary-table-body">
                                    <!-- 表格内容将通过 JavaScript 动态加载 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2024 立信英语. 保留所有权利.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">用心打造高效英语学习平台</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 修改后的 apiService 对象，包含真实的 API 调用 ---
        const apiService = (function () {
            // 从 api.js 或直接定义 API 基础 URL
            const API_BASE_URL = window.ApiBaseUrl || 'http://localhost:3000/api';

            // 模拟从 localStorage 获取 token
            const TOKEN_KEY = 'token';
            function getAuthToken() {
                return localStorage.getItem(TOKEN_KEY);
            }

            return {
                // 真实的获取生词表数据的方法
                getVocabularyList: async function () {
                    const token = getAuthToken();
                    if (!token) {
                       return { success: false, error: '未登录' };
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/vocabulary`, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                             const errorData = await response.json().catch(() => ({}));
                             throw new Error(errorData.error || `请求失败: ${response.status}`);
                        }

                        const result = await response.json();
                        return result; // 后端直接返回 { success: true, vocabulary: [...] }
                    } catch (error) {
                        console.error('获取生词表失败:', error);
                        return { success: false, error: error.message };
                    }
                },
                // 真实的删除生词方法
                deleteVocabularyItem: async function (wordId) {
                    const token = getAuthToken();
                    if (!token) {
                        return { success: false, error: '未登录' };
                    }
                    try {
                        const response = await fetch(`${API_BASE_URL}/vocabulary/${wordId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                             const errorData = await response.json().catch(() => ({}));
                             throw new Error(errorData.error || `删除失败: ${response.status}`);
                        }

                        const result = await response.json();
                        return result; // 后端返回 { success: true, message: '...' }
                    } catch (error) {
                        console.error('删除生词失败:', error);
                        return { success: false, error: error.message };
                    }
                },
                // 真实的导出 CSV 方法
                exportVocabularyCSV: async function () {
                    const token = getAuthToken();
                    if (!token) {
                        throw new Error('未登录');
                    }
                    // 直接调用后端的数据导出 API，它会处理词汇表等所有数据
                    // 如果只想导出词汇表，需要后端提供专门的接口，这里暂时用总导出
                    const response = await fetch(`${API_BASE_URL}/data-export/csv`, {
                         method: 'GET',
                         headers: {
                             'Authorization': `Bearer ${token}`
                             // 注意：对于文件下载，通常不需要 'Content-Type': 'application/json'
                         }
                    });

                    if (!response.ok) {
                        // 尝试读取错误信息
                        let errorMsg = `导出失败: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = errorData.error || errorMsg;
                        } catch (e) {
                            // 如果不是 JSON，尝试获取文本
                            try {
                                errorMsg = await response.text();
                            } catch (e2) {
                                // 忽略，使用默认消息
                            }
                        }
                        throw new Error(errorMsg);
                    }

                    // 如果响应是成功的，它应该是一个文件流
                    // 返回 Blob 以便后续处理（如触发下载）
                    return await response.blob();
                },
                logout: function () {
                    localStorage.removeItem(TOKEN_KEY);
                }
            };
        })();

        // --- 前端逻辑 ---
        // 检查登录状态 (与 data-export.html 相同)
        async function checkLogin() {
            const token = localStorage.getItem('token');
            const userInfo = document.getElementById('user-info');
            const profileBtn = document.getElementById('profile-btn');
            const recordsBtn = document.getElementById('records-btn');
            const adminBtn = document.getElementById('admin-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            if (!token) {
                loginBtn.classList.remove('d-none');
                document.getElementById('vocabulary-table-body').innerHTML = '<tr><td colspan="6" class="text-center">请先 <a href="login.html">登录</a> 查看您的生词表。</td></tr>';
                return;
            }
            try {
                const response = await fetch('http://localhost:3000/api/user', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                const result = await response.json();
                if (result.success) {
                    const user = result.user;
                    userInfo.textContent = `欢迎, ${user.name || user.email}`;
                    userInfo.classList.remove('d-none');
                    profileBtn.classList.remove('d-none');
                    recordsBtn.classList.remove('d-none');
                    // 检查是否为管理员
                    const adminEmails = ['admin@example.com', 'admin@liuxinenglish.com']; // 应从后端获取
                    if (adminEmails.includes(user.email)) {
                        adminBtn.classList.remove('d-none');
                    }
                    loginBtn.classList.add('d-none');
                    logoutBtn.classList.remove('d-none');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('检查登录状态失败:', error);
                localStorage.removeItem('token');
                document.getElementById('vocabulary-table-body').innerHTML = '<tr><td colspan="6" class="text-center">登录状态检查失败，请 <a href="login.html">重新登录</a>。</td></tr>';
            }
        }

        // 显示消息
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = `alert alert-${type} d-block`;
            // 5秒后自动隐藏
            setTimeout(() => {
                messageDiv.classList.add('d-none');
            }, 5000);
        }

        // 加载生词表数据到表格 (修改后)
        async function loadVocabularyList() {
            try {
                showMessage('正在加载生词表...', 'info');
                const result = await apiService.getVocabularyList();
                console.log("从后端获取的生词表数据:", result);

                const tableBody = document.getElementById('vocabulary-table-body');
                tableBody.innerHTML = ''; // 清空现有内容

                if (result.success) {
                    const vocabList = result.vocabulary || [];
                    if (vocabList.length === 0) {
                         tableBody.innerHTML = '<tr><td colspan="6" class="text-center">您的生词表是空的。</td></tr>';
                         showMessage('生词表加载完成，但列表为空。', 'warning');
                         return;
                    }

                    vocabList.forEach((item, index) => {
                        const addedDate = item.createdAt ? new Date(item.createdAt).toLocaleDateString() : 'N/A';
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <th scope="row">${index + 1}</th>
                            <td>${item.word || 'N/A'}</td>
                            <td>${item.translation || 'N/A'}</td>
                            <td>${item.source || 'N/A'}</td>
                            <td>${addedDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${item._id}">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });

                    // 为新添加的删除按钮绑定事件
                    document.querySelectorAll('.delete-btn').forEach(button => {
                        button.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const wordId = e.currentTarget.getAttribute('data-id');
                            if (wordId && confirm('确定要删除这个单词吗？')) {
                                try {
                                    showMessage('正在删除...', 'info');
                                    const deleteResult = await apiService.deleteVocabularyItem(wordId);
                                    if (deleteResult.success) {
                                        showMessage('单词删除成功！', 'success');
                                        // 重新加载列表以反映更改
                                        loadVocabularyList();
                                    } else {
                                        throw new Error(deleteResult.error);
                                    }
                                } catch (error) {
                                    console.error('删除失败:', error);
                                    showMessage('删除失败：' + error.message, 'danger');
                                }
                            }
                        });
                    });

                    showMessage('生词表加载成功！', 'success');
                } else {
                    throw new Error(result.error || '加载失败');
                }
            } catch (error) {
                console.error('加载生词表失败:', error);
                showMessage('加载生词表失败：' + error.message, 'danger');
                document.getElementById('vocabulary-table-body').innerHTML = `<tr><td colspan="6" class="text-center">加载失败: ${error.message}</td></tr>`;
            }
        }

        // 导出 CSV 功能
        async function exportVocabularyCSV() {
            const exportBtn = document.getElementById('export-btn');
            const originalHtml = exportBtn.innerHTML;
            exportBtn.innerHTML = '<span class="loading-spinner" role="status"></span> 导出中...';
            exportBtn.disabled = true;

            try {
                showMessage('正在准备导出文件...', 'info');
                const blob = await apiService.exportVocabularyCSV();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // 设置文件名
                const now = new Date();
                const dateString = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                a.download = `vocabulary_export_${dateString}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                // 释放创建的 URL 对象
                window.URL.revokeObjectURL(url);
                showMessage('生词表导出成功！文件将自动下载。', 'success');
            } catch (error) {
                console.error('导出失败:', error);
                showMessage('导出失败：' + error.message, 'danger');
            } finally {
                exportBtn.innerHTML = originalHtml;
                exportBtn.disabled = false;
            }
        }

        // 登出功能
        document.getElementById('logout-btn').addEventListener('click', () => {
            apiService.logout();
            window.location.href = 'index.html';
        });

        // 登录按钮事件
        document.getElementById('login-btn').addEventListener('click', () => {
            window.location.href = 'login.html';
        });

        // 刷新按钮事件
        document.getElementById('refresh-btn').addEventListener('click', () => {
            loadVocabularyList();
        });

        // 导出按钮事件
        document.getElementById('export-btn').addEventListener('click', () => {
            exportVocabularyCSV();
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            checkLogin().then(() => {
                 const token = localStorage.getItem('token');
                 if (token) {
                     loadVocabularyList();
                 }
            }).catch(err => {
                 console.log("初始化时遇到错误，可能已跳转或显示错误信息。", err);
            });
        });
    </script>
</body>
</html>