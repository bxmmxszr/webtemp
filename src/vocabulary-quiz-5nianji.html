<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>词汇测试 - 五年级英语 - 立信英语</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        .quiz-card {
            transition: transform 0.2s;
            cursor: pointer;
        }
        .quiz-card:hover {
            transform: translateY(-5px);
        }
        .progress-container {
            position: sticky;
            top: 70px;
            z-index: 1000;
            background: white;
            padding: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .question-card {
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .option-btn {
            transition: all 0.2s;
        }
        .option-btn:hover {
            transform: scale(1.02);
        }
        .result-card {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .timer {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .flashcard {
            perspective: 1000px;
            height: 200px;
            margin: 20px 0;
        }
        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }
        .flashcard-front, .flashcard-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            border-radius: 10px;
        }
        .flashcard-front {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .flashcard-back {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: rotateY(180deg);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">立信英语</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#about">关于</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#services">服务</a></li>
                    <li class="nav-item"><a class="nav-link" href="si-nian-ji.html">文章</a></li>
                    <li class="nav-item"><a class="nav-link" href="wu-nian-ji.html">五年级</a></li>
                    <!-- 登录状态显示 - 添加的部分 -->
                    <li class="nav-item">
                        <span id="user-info" class="navbar-text me-2 d-none"></span>
                        <a href="profile.html" class="btn btn-outline-primary btn-sm me-1 d-none" id="profile-btn">个人中心</a>
                        <a href="learning-records.html" class="btn btn-outline-info btn-sm me-1 d-none" id="records-btn">学习记录</a>
                        <a href="admin-vocabulary.html" class="btn btn-outline-warning btn-sm me-1 d-none" id="admin-btn">管理员</a>
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-1">登录</button>
                        <button id="logout-btn" class="btn btn-outline-secondary btn-sm d-none">登出</button>
                    </li>
                    <!-- 登录状态显示结束 -->
                    <li class="nav-item"><a class="nav-link" href="index.html#contact">联系</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- 页面内容 -->
    <div class="container mt-5 pt-5">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>五年级英语</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="wu-nian-ji.html" class="list-group-item list-group-item-action">
                            返回主页面
                        </a>
                        <a href="translation-practice-5nianji.html" class="list-group-item list-group-item-action">
                            翻译特训
                        </a>
                        <a href="core-vocabulary-5nianji.html" class="list-group-item list-group-item-action">
                            核心词汇积累
                        </a>
                        <a href="vocabulary-quiz-5nianji.html" class="list-group-item list-group-item-action active">
                            词汇测试
                        </a>
                        <a href="si-nian-ji.html" class="list-group-item list-group-item-action">
                            ← 返回文章
                        </a>
                    </div>
                </div>
            </div>
            <!-- 主要内容区域 -->
            <div class="col-lg-9">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="index.html">首页</a></li>
                        <li class="breadcrumb-item"><a href="si-nian-ji.html">文章</a></li>
                        <li class="breadcrumb-item"><a href="wu-nian-ji.html">五年级</a></li>
                        <li class="breadcrumb-item active">词汇测试</li>
                    </ol>
                </nav>
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>五年级词汇测试</h2>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="bi bi-funnel"></i> 筛选
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="vocabularyQuiz.filterQuiz('all')">全部词汇</a></li>
                            <li><a class="dropdown-item" href="#" onclick="vocabularyQuiz.filterQuiz('new')">新学词汇</a></li>
                            <li><a class="dropdown-item" href="#" onclick="vocabularyQuiz.filterQuiz('review')">复习词汇</a></li>
                            <li><a class="dropdown-item" href="#" onclick="vocabularyQuiz.filterQuiz('mastered')">已掌握</a></li>
                        </ul>
                    </div>
                </div>
                <!-- 测试进度 -->
                <div class="progress-container mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>测试进度</span>
                        <span id="progress-text">0/0</span>
                    </div>
                    <div class="progress">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <!-- 词汇测试内容 -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">词汇测试</h4>
                        <div class="timer" id="timer">⏱️ <span id="time-left">00:00</span></div>
                    </div>
                    <div class="card-body">
                        <div id="message" class="alert d-none" role="alert"></div>
                        <!-- 测试开始界面 -->
                        <div id="start-quiz-tab" class="tab-content">
                            <div class="text-center">
                                <h5>开始词汇测试</h5>
                                <p class="lead mb-4">基于您已学的词汇进行测试，巩固学习成果</p>
                                <div class="row mb-4">
                                    <div class="col-md-6 mb-3">
                                        <div class="card bg-primary text-white">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">总测试数</h6>
                                                <h2 class="mb-0" id="total-tests">0</h2>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="card bg-success text-white">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">正确率</h6>
                                                <h2 class="mb-0" id="accuracy-rate">0%</h2>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <h6>选择测试类型</h6>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="card quiz-card">
                                                <div class="card-body text-center">
                                                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                        <span class="fs-4">🔤</span>
                                                    </div>
                                                    <h6 class="card-title">中译英</h6>
                                                    <p class="card-text small">根据中文意思选择正确的英文单词</p>
                                                    <button class="btn btn-primary" onclick="vocabularyQuiz.startQuiz('chinese-to-english')">
                                                        开始测试
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card quiz-card">
                                                <div class="card-body text-center">
                                                    <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                        <span class="fs-4">📖</span>
                                                    </div>
                                                    <h6 class="card-title">英译中</h6>
                                                    <p class="card-text small">根据英文单词选择正确的中文意思</p>
                                                    <button class="btn btn-success" onclick="vocabularyQuiz.startQuiz('english-to-chinese')">
                                                        开始测试
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="card quiz-card">
                                                <div class="card-body text-center">
                                                    <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                                        <span class="fs-4">⌨️</span>
                                                    </div>
                                                    <h6 class="card-title">拼写测试</h6>
                                                    <p class="card-text small">根据中文意思拼写出正确的英文单词</p>
                                                    <button class="btn btn-info" onclick="vocabularyQuiz.startQuiz('spelling')">
                                                        开始测试
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="alert alert-info">
                                    <h6><i class="bi bi-info-circle"></i> 测试说明</h6>
                                    <ul class="mb-0">
                                        <li>测试基于您已学习的核心词汇</li>
                                        <li>每次测试包含10个题目</li>
                                        <li>测试完成后会显示成绩和详细分析</li>
                                        <li>系统会根据测试结果调整复习计划</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <!-- 测试进行中界面 -->
                        <div id="quiz-progress-tab" class="tab-content d-none">
                            <div class="question-card">
                                <div id="question-container">
                                    <div class="text-center">
                                        <div class="spinner-border" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 测试结果界面 -->
                        <div id="quiz-results-tab" class="tab-content d-none">
                            <div class="result-card">
                                <div id="results-container">
                                    <!-- 结果将动态加载 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 测试历史记录 -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">测试历史记录</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>测试类型</th>
                                        <th>日期</th>
                                        <th>题目数</th>
                                        <th>正确数</th>
                                        <th>得分</th>
                                        <th>耗时</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody id="quiz-history-table">
                                    <tr>
                                        <td colspan="7" class="text-center">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav aria-label="测试历史分页">
                            <ul class="pagination justify-content-center" id="quiz-history-pagination">
                                <!-- 分页将动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- 页脚 -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">© 2024 立信英语. 保留所有权利.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">用心打造高效英语学习平台</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="api.js"></script>
    <script>
        // --- 词汇测试系统 - 五年级版本 - 修复版 ---
        class VocabularyQuizSystem {
            constructor() {
                this.vocabulary = [];
                this.quizQuestions = [];
                this.currentQuestionIndex = 0;
                this.quizScore = 0;
                this.quizMode = '';
                this.startTime = null;
                this.endTime = null;
                this.timerInterval = null;
                this.timeLeft = 300; // 5分钟倒计时
                this.quizHistory = [];
                this.currentPage = 1;
                this.pageSize = 10;
                this.totalPages = 0;
                // --- 修改1: 确保 API_BASE_URL 指向正确的后端地址 ---
                this.apiBaseUrl = 'http://localhost:3000/api'; // 确保此地址与您的后端服务器地址匹配
            }
            // 初始化测试系统
            async init() {
                await this.checkLogin();
                await this.loadUserVocabulary(); // 加载五年级词汇
                await this.loadQuizHistory(); // 修复：加载真实的测试历史记录
                this.updateStatistics();
            }
            // 检查登录状态
            async checkLogin() {
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return false;
                }
                try {
                    const result = await apiService.getUserInfo();
                    this.updateUIForUser(result.user);
                    return result.user;
                } catch (error) {
                    console.error('Token验证失败:', error);
                    apiService.logout();
                    window.location.href = 'login.html';
                    return false;
                }
            }
            // 根据用户状态更新UI
            updateUIForUser(user) {
                const userInfo = document.getElementById('user-info');
                const profileBtn = document.getElementById('profile-btn');
                const recordsBtn = document.getElementById('records-btn');
                const adminBtn = document.getElementById('admin-btn');
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                if (user) {
                    // 用户已登录
                    userInfo.textContent = `欢迎, ${user.name || user.email}`;
                    userInfo.classList.remove('d-none');
                    profileBtn.classList.remove('d-none');
                    recordsBtn.classList.remove('d-none');
                    loginBtn.classList.add('d-none');
                    logoutBtn.classList.remove('d-none');
                    // 检查是否为管理员
                    const adminEmails = ['admin@example.com', 'admin@liuxinenglish.com'];
                    if (adminEmails.includes(user.email)) {
                        adminBtn.classList.remove('d-none');
                    } else {
                        adminBtn.classList.add('d-none');
                    }
                } else {
                    // 用户未登录
                    userInfo.classList.add('d-none');
                    profileBtn.classList.add('d-none');
                    recordsBtn.classList.add('d-none');
                    adminBtn.classList.add('d-none');
                    loginBtn.classList.remove('d-none');
                    logoutBtn.classList.add('d-none');
                }
            }
            // 加载用户已学词汇 (五年级)
            async loadUserVocabulary() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('请先登录');
                    }
                    console.log('开始从后端加载五年级用户词汇...');
                    // --- 修改2: 调用后端API获取五年级核心词汇 ---
                    const response = await fetch(`${this.apiBaseUrl}/core-vocabulary/daily?count=50&category=grade5`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    console.log('后端响应状态 (五年级词汇):', response.status);
                    // 检查响应内容类型
                    const contentType = response.headers.get('content-type');
                    console.log('响应内容类型 (五年级词汇):', contentType);
                    if (!contentType || !contentType.includes('application/json')) {
                        const text = await response.text();
                        console.error('服务器返回非JSON响应:', text.substring(0, 200));
                        throw new Error('服务器返回了错误响应，请检查后端服务是否正常运行');
                    }
                    const result = await response.json();
                    console.log('后端响应数据 (五年级词汇):', result);
                    if (result.success) {
                        this.vocabulary = result.vocabulary || [];
                        console.log('成功加载五年级词汇:', this.vocabulary.length, '个');
                    } else {
                        throw new Error(result.error || '获取词汇失败');
                    }
                } catch (error) {
                    console.error('加载用户词汇失败:', error);
                    // 使用模拟数据作为后备 (五年级词汇示例)
                    this.vocabulary = this.getMockVocabulary();
                }
            }
            // 获取模拟五年级词汇数据
            getMockVocabulary() {
                return [
                    {
                        _id: '801',
                        word: "analyze",
                        pronunciation: "/ˈænəlaɪz/",
                        translation: "分析",
                        partOfSpeech: "动词",
                        example: "Scientists analyze data to find patterns.",
                        exampleTranslation: "科学家分析数据以寻找规律。",
                        difficulty: "intermediate",
                        category: "academic",
                        tags: ["学术词汇", "科学方法"]
                    },
                    {
                        _id: '802',
                        word: "significant",
                        pronunciation: "/sɪɡˈnɪfɪkənt/",
                        translation: "重要的，有意义的",
                        partOfSpeech: "形容词",
                        example: "There was a significant improvement after the training.",
                        exampleTranslation: "培训后有了显著的改进。",
                        difficulty: "intermediate",
                        category: "description",
                        tags: ["描述词汇", "正式用语"]
                    },
                    {
                        _id: '803',
                        word: "perspective",
                        pronunciation: "/pərˈspektɪv/",
                        translation: "观点，视角；透视",
                        partOfSpeech: "名词",
                        example: "Try to see it from his perspective.",
                        exampleTranslation: "试着从他的角度看问题。",
                        difficulty: "advanced",
                        category: "thinking",
                        tags: ["思维词汇", "哲学"]
                    },
                    {
                        _id: '804',
                        word: "phenomenon",
                        pronunciation: "/fəˈnɑːmɪnən/",
                        translation: "现象",
                        partOfSpeech: "名词",
                        example: "The Northern Lights are a natural phenomenon.",
                        exampleTranslation: "北极光是一种自然现象。",
                        difficulty: "advanced",
                        category: "science",
                        tags: ["科学词汇", "单复数phenomena"]
                    },
                    {
                        _id: '805',
                        word: "sophisticated",
                        pronunciation: "/səˈfɪstɪkeɪtɪd/",
                        translation: "复杂的，精密的；老练的",
                        partOfSpeech: "形容词",
                        example: "This camera has sophisticated features.",
                        exampleTranslation: "这台相机有复杂的功能。",
                        difficulty: "advanced",
                        category: "technology",
                        tags: ["科技词汇", "正式用语"]
                    }
                ];
            }
            // 开始测试
            async startQuiz(mode) {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) {
                        alert('请先登录获取访问权限');
                        window.location.href = 'login.html';
                        return;
                    }
                    this.quizMode = mode;
                    this.currentQuestionIndex = 0;
                    this.quizScore = 0;
                    this.startTime = new Date();
                    this.timeLeft = 300; // 5分钟倒计时
                    // 生成测试题目
                    await this.generateQuizQuestions();
                    // 显示测试界面
                    this.showQuizInterface();
                    // 开始计时
                    this.startTimer();
                } catch (error) {
                    console.error('开始测试失败:', error);
                    this.showMessage('开始测试失败：' + error.message, 'danger');
                }
            }
            // 生成测试题目
            async generateQuizQuestions() {
                this.quizQuestions = [];
                const shuffledVocabulary = [...this.vocabulary].sort(() => Math.random() - 0.5);
                shuffledVocabulary.slice(0, 10).forEach(word => {
                    let question = {};
                    switch(this.quizMode) {
                        case 'chinese-to-english':
                            question = {
                                type: 'chinese-to-english',
                                question: `"${word.translation}" 的英文是什么？`,
                                correctAnswer: word.word.toLowerCase(),
                                options: this.generateOptions(word.word, 'english'),
                                word: word
                            };
                            break;
                        case 'english-to-chinese':
                            question = {
                                type: 'english-to-chinese',
                                question: `"${word.word}" 的中文意思是什么？`,
                                correctAnswer: word.translation,
                                options: this.generateOptions(word.translation, 'chinese'),
                                word: word
                            };
                            break;
                        case 'spelling':
                            question = {
                                type: 'spelling',
                                question: `请拼写单词：${word.translation}`,
                                correctAnswer: word.word.toLowerCase(),
                                word: word
                            };
                            break;
                    }
                    this.quizQuestions.push(question);
                });
            }
            // 生成选项
            generateOptions(correctAnswer, type) {
                const options = [correctAnswer];
                const allAnswers = type === 'english' 
                    ? this.vocabulary.map(w => w.word) 
                    : this.vocabulary.map(w => w.translation);
                const wrongAnswers = allAnswers
                    .filter(answer => answer !== correctAnswer)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, 3);
                return [...options, ...wrongAnswers].sort(() => Math.random() - 0.5);
            }
            // 显示测试界面
            showQuizInterface() {
                document.getElementById('start-quiz-tab').classList.add('d-none');
                document.getElementById('quiz-progress-tab').classList.remove('d-none');
                document.getElementById('quiz-results-tab').classList.add('d-none');
                this.showQuizQuestion();
            }
            // 显示测试问题
            showQuizQuestion() {
                const questionContainer = document.getElementById('question-container');
                const question = this.quizQuestions[this.currentQuestionIndex];
                if (!question) {
                    this.endQuiz();
                    return;
                }
                let html = `
                    <div class="text-center">
                        <h5>测试进行中 (${this.currentQuestionIndex + 1}/${this.quizQuestions.length})</h5>
                        <p class="lead mb-4">${question.question}</p>
                `;
                if (this.quizMode === 'spelling') {
                    html += `
                        <div class="mb-3">
                            <input type="text" class="form-control" id="answerInput" placeholder="请输入答案">
                        </div>
                        <button class="btn btn-primary" onclick="vocabularyQuiz.checkSpellingAnswer()">
                            <span id="submitBtnText">提交</span>
                            <span id="submitBtnLoading" class="spinner-border spinner-border-sm d-none" role="status"></span>
                        </button>
                    `;
                } else {
                    html += '<div class="row">';
                    question.options.forEach((option, index) => {
                        html += `
                            <div class="col-md-6 mb-2">
                                <button class="btn btn-outline-primary option-btn w-100" onclick="vocabularyQuiz.checkMultipleChoiceAnswer('${option}')">
                                    ${option}
                                </button>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                html += '</div>';
                questionContainer.innerHTML = html;
            }
            // 检查拼写答案
            async checkSpellingAnswer() {
                const input = document.getElementById('answerInput');
                const answer = input.value.trim().toLowerCase();
                const question = this.quizQuestions[this.currentQuestionIndex];
                const submitBtn = document.getElementById('submitBtnText').parentElement;
                const submitBtnText = document.getElementById('submitBtnText');
                const submitBtnLoading = document.getElementById('submitBtnLoading');
                // 显示加载状态
                submitBtn.disabled = true;
                submitBtnText.classList.add('d-none');
                submitBtnLoading.classList.remove('d-none');
                let isCorrect = false;
                if (answer === question.correctAnswer) {
                    this.quizScore++;
                    this.showMessage('回答正确！', 'success');
                    isCorrect = true;
                } else {
                    this.showMessage(`回答错误！正确答案是：${question.correctAnswer}`, 'danger');
                }
                // 更新学习记录 (模拟)
                try {
                    const token = localStorage.getItem('token');
                    if (token) {
                         await fetch(`${this.apiBaseUrl}/core-vocabulary/record`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                vocabularyId: question.word._id,
                                status: 'reviewing',
                                isCorrect: isCorrect
                            })
                        });
                    }
                } catch (error) {
                    console.error('更新学习记录失败:', error);
                }
                // 恢复按钮状态
                submitBtn.disabled = false;
                submitBtnText.classList.remove('d-none');
                submitBtnLoading.classList.add('d-none');
                this.currentQuestionIndex++;
                setTimeout(() => {
                    this.showQuizQuestion();
                }, 1500);
            }
            // 检查选择题答案
            async checkMultipleChoiceAnswer(selectedAnswer) {
                const question = this.quizQuestions[this.currentQuestionIndex];
                let isCorrect = false;
                if (selectedAnswer === question.correctAnswer) {
                    this.quizScore++;
                    this.showMessage('回答正确！', 'success');
                    isCorrect = true;
                } else {
                    this.showMessage(`回答错误！正确答案是：${question.correctAnswer}`, 'danger');
                }
                // 更新学习记录 (模拟)
                try {
                    const token = localStorage.getItem('token');
                    if (token) {
                         await fetch(`${this.apiBaseUrl}/core-vocabulary/record`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                vocabularyId: question.word._id,
                                status: 'reviewing',
                                isCorrect: isCorrect
                            })
                        });
                    }
                } catch (error) {
                    console.error('更新学习记录失败:', error);
                }
                this.currentQuestionIndex++;
                setTimeout(() => {
                    this.showQuizQuestion();
                }, 1500);
            }
            // 显示消息
            showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = `alert alert-${type} d-block`;
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 3000);
            }
            // 开始计时器
            startTimer() {
                clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    this.timeLeft--;
                    const minutes = Math.floor(this.timeLeft / 60);
                    const seconds = this.timeLeft % 60;
                    document.getElementById('time-left').textContent = 
                        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    if (this.timeLeft <= 0) {
                        this.endQuiz();
                    }
                }, 1000);
            }
            // 结束测试
            endQuiz() {
                clearInterval(this.timerInterval);
                this.endTime = new Date();
                this.showQuizResults();
                this.saveQuizRecord(); // 修复：保存测试记录
            }
            // 显示测试结果
            showQuizResults() {
                document.getElementById('quiz-progress-tab').classList.add('d-none');
                document.getElementById('quiz-results-tab').classList.remove('d-none');
                const resultsContainer = document.getElementById('results-container');
                const percentage = Math.round((this.quizScore / this.quizQuestions.length) * 100);
                const timeTaken = Math.round((this.endTime - this.startTime) / 1000);
                resultsContainer.innerHTML = `
                    <div class="text-center">
                        <h3>测试完成！</h3>
                        <div class="mb-3">
                            <div class="display-4 text-${percentage >= 80 ? 'success' : percentage >= 60 ? 'warning' : 'danger'}">
                                ${percentage}%
                            </div>
                            <p>得分：${this.quizScore}/${this.quizQuestions.length}</p>
                            <p>用时：${Math.floor(timeTaken / 60)}分${timeTaken % 60}秒</p>
                        </div>
                        <div class="mb-3">
                            ${percentage >= 80 ? 
                                '<div class="alert alert-success">优秀！继续保持！</div>' : 
                                percentage >= 60 ? 
                                '<div class="alert alert-warning">不错，但还有提升空间！</div>' : 
                                '<div class="alert alert-danger">需要继续努力哦！</div>'
                            }
                        </div>
                        <button class="btn btn-primary me-2" onclick="vocabularyQuiz.restartQuiz()">
                            <i class="bi bi-arrow-repeat"></i> 再次测试
                        </button>
                        <button class="btn btn-secondary" onclick="vocabularyQuiz.backToStart()">
                            <i class="bi bi-arrow-left"></i> 返回学习
                        </button>
                        <div class="card bg-light mt-4">
                            <div class="card-header">
                                <h5>详细分析</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>正确率</h6>
                                                <h3 class="text-${percentage >= 80 ? 'success' : percentage >= 60 ? 'warning' : 'danger'}">${percentage}%</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>答题数</h6>
                                                <h3>${this.quizQuestions.length}</h3>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 mb-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6>用时</h6>
                                                <h3>${Math.floor(timeTaken / 60)}分${timeTaken % 60}秒</h3>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            // 重新开始测试
            restartQuiz() {
                this.startQuiz(this.quizMode);
            }
            // 返回开始界面
            backToStart() {
                document.getElementById('quiz-results-tab').classList.add('d-none');
                document.getElementById('start-quiz-tab').classList.remove('d-none');
                this.updateStatistics();
            }
            // 保存测试记录 - 修复版本
            async saveQuizRecord() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;
                    const timeTaken = Math.round((this.endTime - this.startTime) / 1000);
                    const quizRecord = {
                        type: this.quizMode,
                        score: Math.round((this.quizScore / this.quizQuestions.length) * 100),
                        questions: this.quizQuestions.length,
                        correct: this.quizScore,
                        timeTaken: timeTaken,
                        date: new Date()
                    };
                    // --- 修改3: 使用与七年级相同的 /api/quiz-records API 路径 ---
                    const response = await fetch(`${this.apiBaseUrl}/quiz-records`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(quizRecord)
                    });
                    const result = await response.json();
                    console.log('测试记录保存结果:', result);
                    if (result.success) {
                        console.log('测试记录保存成功:', result.record);
                        // 重新加载测试历史记录
                        await this.loadQuizHistory();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('保存测试记录失败:', error);
                    // 可以添加用户友好的错误提示
                    // alert('保存测试记录失败：' + error.message);
                }
            }
            // 加载测试历史记录 - 修复版本
            async loadQuizHistory() {
                try {
                    const token = localStorage.getItem('token');
                    if (!token) return;
                    // --- 修改4: 使用与七年级相同的 /api/quiz-records API 路径 ---
                    const response = await fetch(`${this.apiBaseUrl}/quiz-records`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const result = await response.json();
                    console.log('获取测试历史记录结果:', result);
                    if (result.success) {
                        this.quizHistory = result.records || [];
                        this.renderQuizHistory();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('加载测试历史记录失败:', error);
                    // 使用模拟数据作为后备
                    this.quizHistory = this.getMockQuizHistory();
                    this.renderQuizHistory();
                }
            }
            // 获取模拟测试历史记录
            getMockQuizHistory() {
                return [
                    {
                        _id: '1',
                        type: 'chinese-to-english',
                        date: '2024-01-20T10:30:00Z',
                        questions: 10,
                        correct: 8,
                        score: 80,
                        timeTaken: 180
                    },
                    {
                        _id: '2',
                        type: 'english-to-chinese',
                        date: '2024-01-19T14:15:00Z',
                        questions: 10,
                        correct: 7,
                        score: 70,
                        timeTaken: 210
                    },
                    {
                        _id: '3',
                        type: 'spelling',
                        date: '2024-01-18T09:45:00Z',
                        questions: 10,
                        correct: 9,
                        score: 90,
                        timeTaken: 150
                    },
                    {
                        _id: '4',
                        type: 'chinese-to-english',
                        date: '2024-01-17T16:20:00Z',
                        questions: 10,
                        correct: 6,
                        score: 60,
                        timeTaken: 240
                    },
                    {
                        _id: '5',
                        type: 'english-to-chinese',
                        date: '2024-01-16T11:10:00Z',
                        questions: 10,
                        correct: 8,
                        score: 80,
                        timeTaken: 190
                    }
                ];
            }
            // 渲染测试历史记录 - 修复版本
            renderQuizHistory() {
                const tableBody = document.getElementById('quiz-history-table');
                if (this.quizHistory.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center">暂无测试记录</td></tr>';
                    return;
                }
                let html = '';
                this.quizHistory.forEach(record => {
                    const typeName = this.getQuizTypeName(record.type);
                    const timeMinutes = Math.floor(record.timeTaken / 60);
                    const timeSeconds = record.timeTaken % 60;
                    const recordDate = new Date(record.date).toLocaleDateString();
                    html += `
                        <tr>
                            <td>${typeName}</td>
                            <td>${recordDate}</td>
                            <td>${record.questions}</td>
                            <td>${record.correct}</td>
                            <td>
                                <span class="badge ${
                                    record.score >= 80 ? 'bg-success' : 
                                    record.score >= 60 ? 'bg-warning' : 'bg-danger'
                                }">
                                    ${record.score}%
                                </span>
                            </td>
                            <td>${timeMinutes}分${timeSeconds}秒</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" onclick="vocabularyQuiz.viewQuizDetails('${record._id}')">
                                    <i class="bi bi-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
                this.renderPagination();
            }
            // 获取测试类型名称
            getQuizTypeName(type) {
                const typeMap = {
                    'chinese-to-english': '中译英',
                    'english-to-chinese': '英译中',
                    'spelling': '拼写测试'
                };
                return typeMap[type] || type;
            }
            // 查看测试详情
            viewQuizDetails(recordId) {
                const record = this.quizHistory.find(r => r._id === recordId);
                if (record) {
                    alert(`
                        测试详情：
                        类型：${this.getQuizTypeName(record.type)}
                        日期：${new Date(record.date).toLocaleString('zh-CN')}
                        题目数：${record.questions}
                        正确数：${record.correct}
                        得分：${record.score}%
                        用时：${Math.floor(record.timeTaken / 60)}分${record.timeTaken % 60}秒
                    `);
                }
            }
            // 渲染分页
            renderPagination() {
                const pagination = document.getElementById('quiz-history-pagination');
                this.totalPages = Math.ceil(this.quizHistory.length / this.pageSize);

                if (this.totalPages <= 1) {
                    pagination.innerHTML = '';
                    return;
                }

                let html = '';

                // 上一页
                html += `
                    <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="vocabularyQuiz.goToPage(${this.currentPage - 1})">上一页</a>
                    </li>
                `;

                // 页码
                for (let i = 1; i <= this.totalPages; i++) {
                    html += `
                        <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="vocabularyQuiz.goToPage(${i})">${i}</a>
                        </li>
                    `;
                }

                // 下一页
                html += `
                    <li class="page-item ${this.currentPage === this.totalPages ? 'disabled' : ''}">
                        <a class="page-link" href="#" onclick="vocabularyQuiz.goToPage(${this.currentPage + 1})">下一页</a>
                    </li>
                `;

                pagination.innerHTML = html;
            }
            // 跳转到指定页面
            goToPage(page) {
                if (page >= 1 && page <= this.totalPages) {
                    this.currentPage = page;
                    this.renderQuizHistory();
                }
            }
            // 筛选测试
            filterQuiz(filterType) {
                alert(`筛选功能将在后续版本中实现！当前筛选: ${filterType}`);
            }
            // 更新统计信息
            updateStatistics() {
                const totalWords = this.vocabulary.length;
                const masteredWords = 0; // 这里应该从后端获取实际数据
                const reviewWords = 0; // 这里应该从后端获取实际数据
                const masteryRate = totalWords > 0 ? Math.round((masteredWords / totalWords) * 100) : 0;
                document.getElementById('total-tests').textContent = totalWords;
                document.getElementById('accuracy-rate').textContent = `${masteryRate}%`;
                // 更新进度条
                document.getElementById('progress-bar').style.width = `${masteryRate}%`;
                document.getElementById('progress-text').textContent = `${masteredWords}/${totalWords}`;
            }
        }
        // 创建全局词汇测试系统实例
        const vocabularyQuiz = new VocabularyQuizSystem();
        // 登出按钮事件
        document.getElementById('logout-btn').addEventListener('click', () => {
            apiService.logout();
            window.location.href = 'index.html';
        });
        // 登录按钮事件
        document.getElementById('login-btn').addEventListener('click', () => {
            window.location.href = 'login.html';
        });
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function() {
            // 检查登录状态
            const user = await vocabularyQuiz.checkLogin();
            if (!user) {
                return;
            }
			// 显示用户信息
            vocabularyQuiz.updateUIForUser(user);
            // 加载用户词汇 (五年级)
            await vocabularyQuiz.loadUserVocabulary();
            // 加载测试历史记录
            await vocabularyQuiz.loadQuizHistory();
            // 更新统计信息
            vocabularyQuiz.updateStatistics();
        });
        // 全局函数绑定
        function flipCard() {
            vocabularyQuiz.flipCard();
        }
        function prevCard() {
            vocabularyQuiz.prevCard();
        }
        function nextCard() {
            vocabularyQuiz.nextCard();
        }
        function markAsLearned() {
            vocabularyQuiz.markAsLearned();
        }
        function addToReview() {
            vocabularyQuiz.addToReview();
        }
        function filterQuiz(filterType) {
            vocabularyQuiz.filterQuiz(filterType);
        }
        function startQuiz(mode) {
            vocabularyQuiz.startQuiz(mode);
        }
        function checkSpellingAnswer() {
            vocabularyQuiz.checkSpellingAnswer();
        }
        function checkMultipleChoiceAnswer(selectedAnswer) {
            vocabularyQuiz.checkMultipleChoiceAnswer(selectedAnswer);
        }
        function restartQuiz() {
            vocabularyQuiz.restartQuiz();
        }
        function backToStart() {
            vocabularyQuiz.backToStart();
        }
        function viewQuizDetails(recordId) {
            vocabularyQuiz.viewQuizDetails(recordId);
        }
        function goToPage(page) {
            vocabularyQuiz.goToPage(page);
        }
    </script>
</body>
</html>